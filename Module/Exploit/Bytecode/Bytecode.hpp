#pragma once
#include "Workspace/Environment/Environment.hpp"

inline int ModuleScriptOffset = Offsets::External::Bytecode::ModuleScript;
inline int LocalScriptOffset = Offsets::External::Bytecode::LocalScript;

inline std::string DecompressBytecode(const std::string& c) {
    uint8_t h[4]; memcpy(h, c.data(), 4);
    for (int i = 0; i < 4; i++) h[i] = (h[i] ^ "RSB1"[i]) - i * 41;
    std::vector<uint8_t> v(c.begin(), c.end());
    for (size_t i = 0; i < v.size(); i++) v[i] ^= h[i % 4] + i * 41;
    int len; memcpy(&len, v.data() + 4, 4);
    std::string out(len, 0);
    return ZSTD_decompress(out.data(), len, v.data() + 8, v.size() - 8) == len ? out : "";
}

inline std::string ReadBytecode(uintptr_t addr) {
    uintptr_t str = addr + 0x10;
    size_t len = *(size_t*)(str + 0x10);
    size_t cap = *(size_t*)(str + 0x18);
    uintptr_t data_ptr = (cap > 0x0f) ? *(uintptr_t*)(str + 0x00) : str;
    return std::string(reinterpret_cast<const char*>(data_ptr), len);
}

inline int getscriptbytecode(lua_State* L)
{
    if (lua_type(L, 1) != LUA_TUSERDATA) { lua_pushnil(L); return 1; }

    uintptr_t script = *(uintptr_t*)lua_touserdata(L, 1);
    if (!script)
    {
        lua_pushnil(L);
        return 1;
    }

    lua_getfield(L, 1, "ClassName");
    const char* name = lua_tostring(L, -1);
    lua_pop(L, 1);

    uintptr_t addr = name && strcmp(name, "ModuleScript") == 0
        ? *(uintptr_t*)(script + ModuleScriptOffset)
        : *(uintptr_t*)(script + LocalScriptOffset);

    std::string bytecode = ReadBytecode(addr);
    std::string code = addr ? DecompressBytecode(bytecode) : "";
    if (code.empty())
    {
        lua_pushnil(L);
        return 1;
    }

    lua_pushlstring(L, code.data(), code.size());
    return 1;
}

class bytecode_encoder : public Luau::BytecodeEncoder {
    inline void encode(uint32_t* data, size_t count) override {
        for (auto i = 0u; i < count;) {
            uint8_t op = LUAU_INSN_OP(data[i]);
            const auto opLength = Luau::getOpLength(static_cast<LuauOpcode>(op));
            const auto lookupTable = reinterpret_cast<BYTE*>(Offsets::Lua::OpcodeLookupTable);
            uint8_t newOp = op * 227;
            newOp = lookupTable[newOp];
            data[i] = (newOp) | (data[i] & ~0xff);
            i += opLength;
        }
    }
};

inline bytecode_encoder encoder;

inline std::string Compile(const std::string& script) {
    static const char* mutable_Globals[] = {
        "Game", "Workspace", "game", "plugin", "script", "shared", "workspace",
        "_G", "_ENV", nullptr
    };

    Luau::CompileOptions options;
    options.debugLevel = 1;
    options.optimizationLevel = 1;
    options.mutableGlobals = mutable_Globals;
    options.vectorLib = "Vector3";
    options.vectorCtor = "new";
    options.vectorType = "Vector3";

    return Luau::compile(script, options, {}, &encoder);
}
